---
version: '1.5'
type: install
name: Liferay
logo: https://raw.githubusercontent.com/jelastic-jps/liferay/master/images/liferay.png
baseUrl: https://raw.githubusercontent.com/vlobzakov/liferay-cluster/master
homepage: http://www.liferay.com/

description:
  text: /texts/description.md
  short: Leading Open Source web-based platforms to build portals

success:
  text: /texts/success.md 

categories:
- apps/cms

globals:
  DB_USER: "liferay"
  DB_PASS: ${fn.password(8)}

skipNodeEmails: true

nodes:
- cloudlets: 18
  nodeType: tomcat
  tag: 9.0.6-openjdk-1.8.0_161
  links: sqldb:DB
- cloudlets: 8
  count: 2
  nodeType: mysql
  tag: 5.7.22
  env:
    ON_ENV_INSTALL: ""

onInstall:
- installJps:
    jps: https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master/scripts/ms-mm-configuration.jps
    settings:
      path: "https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master"
      db_user: "${globals.DB_USER}"
      db_pass: "${globals.DB_PASS}"
      scheme: "master"
    nodeGroup: sqldb
- changerights
- deployArchive
- createDb
- restartNodes:
    - nodeGroup: cp

actions:
  changerights: 
    cmd[cp]: chmod 777 /opt
    user: root
    
  deployArchive:
    cmd [cp]: |-
      cd /opt
      wget https://sourceforge.net/projects/lportal/files/Liferay%20Portal/7.3.0%20GA1/liferay-ce-portal-tomcat-7.3.0-ga1-20200127150653953.tar.gz/download -O /opt/liferay.tgz
      tgz -zxvf /opt/liferay.zip -C /opt
      mv /opt/liferay-ce-portal-7.3.0-ga1 /opt/liferay
      cp -R /opt/liferay/data /opt
      cp -R /opt/liferay/license /opt
      cp -R /opt/liferay/osgi /opt
      cp -R /opt/liferay/tools /opt
      cp -R /opt/liferay/work /opt
      cp -R /opt/liferay/.liferay-home /opt
      rm -fR /opt/tomcat/webapps/ROOT/*
      cp -nR /opt/liferay/tomcat-9.0.6/* /opt/tomcat/
      cp /opt/liferay/tomcat-9.0.6/conf/catalina.properties /opt/tomcat/conf
      cat << EOF > /opt/tomcat/webapps/ROOT/WEB-INF/classes/portal-ext.properties
      jdbc.default.driverClassName=com.mysql.jdbc.Driver
      jdbc.default.url=jdbc:mysql://sqldb.${env.domain}/lportal?useUnicode=true&characterEncoding=UTF-8&useFastDateParsing=false
      jdbc.default.username=${globals.DB_USER}
      jdbc.default.password=${globals.DB_PASS}
      schema.run.enabled=true
      schema.run.minimal=true
      EOF
      cp /opt/tomcat/webapps/ROOT/WEB-INF/classes/portal-ext.properties /opt
    
  createDb:
       cmd[${nodes.sqldb.master.id}]:
          mysql -u${globals.DB_USER} -p${globals.DB_PASS} -h DB -e "CREATE DATABASE IF NOT EXISTS lportal;"
